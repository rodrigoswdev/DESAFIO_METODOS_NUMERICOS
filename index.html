<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Métodos Numéricos con Exportación a Excel</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin: 20px; }
input, button { padding: 8px; margin: 5px; width: 300px; }
</style>

</head>
<body>

<h1>Métodos Numéricos con Exportación a Excel</h1>

<label>Ecuación f(x)=0:</label><br>
<input id="funcInput" value="x**3 - Math.exp(0.8*x) - 20">

<br>

<label>Intervalo a (Bisección):</label><br>
<input id="aInput" type="number" value="0">

<label>Intervalo b (Bisección):</label><br>
<input id="bInput" type="number" value="8">

<br>

<label>x0 (Newton):</label><br>
<input id="x0Input" type="number" value="3">

<label>x1 (Secante):</label><br>
<input id="x1Input" type="number" value="4">

<br><br>
<button onclick="resolver()">Resolver</button>
<button onclick="exportarExcel()">Exportar Iteraciones a Excel</button>

<hr>

<h2>Resultados</h2>
<div id="resultados"></div>

<hr>

<h2>Gráfica de f(x)</h2>
<div id="graficaFuncion" style="width:100%; height:400px;"></div>

<h2>Comparación de Trayectorias</h2>
<div id="graficaMetodos" style="width:100%; height:400px;"></div>

<script>

// ================================
// PARSER DE ECUACIÓN
// ================================
function crearFuncion(expr) {
    return new Function("x", "return " + expr + ";");
}

// ================================
// BISECCIÓN
// ================================
function biseccion(f, a, b, tol=1e-6, maxIter=100) {
    let hist = [];

    if (f(a) * f(b) > 0) return {root:null, hist};

    for (let i=0;i<maxIter;i++){
        let c = (a+b)/2;
        hist.push({n:i, x:c, fx:f(c), error:Math.abs(b-a)/2});

        if (Math.abs(f(c))<tol || Math.abs(b-a)<tol)
            return {root:c, hist};

        if (f(a)*f(c)<0) b=c;
        else a=c;
    }
    return {root:(a+b)/2, hist};
}

// ================================
// NEWTON
// ================================
function newton(f, x0, tol=1e-6, maxIter=100){
    let h = 1e-6;
    let hist = [];
    let x = x0;

    for (let i=0;i<maxIter;i++){
        let df = (f(x+h) - f(x)) / h;
        if (df===0) return {root:null, hist};

        let x1 = x - f(x)/df;
        hist.push({n:i, x:x1, fx:f(x1), error:Math.abs(x1-x)});

        if (Math.abs(x1-x)<tol)
            return {root:x1, hist};

        x = x1;
    }
    return {root:x, hist};
}

// ================================
// SECANTE
// ================================
function secante(f, x0, x1, tol=1e-6, maxIter=100){
    let hist = [];
    for (let i=0;i<maxIter;i++){
        let f0=f(x0), f1=f(x1);
        if (f1-f0===0) return {root:null, hist};

        let x2 = x1 - f1*(x1-x0)/(f1-f0);
        hist.push({n:i, x:x2, fx:f(x2), error:Math.abs(x2-x1)});

        if (Math.abs(x2-x1)<tol)
            return {root:x2, hist};

        x0=x1; x1=x2;
    }
    return {root:x1, hist};
}

// =====================================
// VARIABLES GLOBALES PARA EXPORTACIÓN
// =====================================
let datos_bis = [];
let datos_newt = [];
let datos_sec = [];

// ================================
// FUNCIÓN PRINCIPAL
// ================================
function resolver() {

    let expr = document.getElementById("funcInput").value;
    let f = crearFuncion(expr);

    let a = parseFloat(document.getElementById("aInput").value);
    let b = parseFloat(document.getElementById("bInput").value);
    let x0 = parseFloat(document.getElementById("x0Input").value);
    let x1 = parseFloat(document.getElementById("x1Input").value);

    let bis = biseccion(f, a, b);
    let newt = newton(f, x0);
    let sec = secante(f, x0, x1);

    datos_bis = bis.hist;
    datos_newt = newt.hist;
    datos_sec = sec.hist;

    document.getElementById("resultados").innerHTML = `
        <b>Bisección:</b> ${bis.root} <br>
        <b>Newton-Raphson:</b> ${newt.root} <br>
        <b>Secante:</b> ${sec.root} <br>
    `;

    // ================
    // GRAFICAR f(x)
    // ================
    let X=[], Y=[];
    for (let i=a;i<=b;i+=(b-a)/300){
        X.push(i);
        Y.push(f(i));
    }

    let data = [
        {x:X,y:Y,type:'scatter',name:'f(x)'},
    ];

    Plotly.newPlot("graficaFuncion", data);

    // =============================
    // GRAFICAR iteraciones
    // =============================
    let plt = [];

    plt.push({
        x: datos_bis.map(e=>e.n),
        y: datos_bis.map(e=>e.x),
        mode:"lines+markers",
        name:"Bisección"
    });

    plt.push({
        x: datos_newt.map(e=>e.n),
        y: datos_newt.map(e=>e.x),
        mode:"lines+markers",
        name:"Newton"
    });

    plt.push({
        x: datos_sec.map(e=>e.n),
        y: datos_sec.map(e=>e.x),
        mode:"lines+markers",
        name:"Secante"
    });

    Plotly.newPlot("graficaMetodos", plt);
}

// ================================
// EXPORTAR A EXCEL
// ================================
function exportarExcel(){

    let wb = XLSX.utils.book_new();

    function agregarHoja(nombre, datos){
        let rows = [["Iteración", "x", "f(x)", "Error"]];
        datos.forEach(d => rows.push([d.n, d.x, d.fx, d.error]));
        let ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, nombre);
    }

    agregarHoja("Biseccion", datos_bis);
    agregarHoja("Newton_Raphson", datos_newt);
    agregarHoja("Secante", datos_sec);

    XLSX.writeFile(wb, "iteraciones_metodos_numericos.xlsx");
}

</script>

</body>
</html>
